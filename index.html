<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Water Tracker</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root { --blue:#0ea5e9; --blue-dark:#0284c7; --bg:#07121f; --card:#0f2236; --text:#e6f2fb; --muted:#9cc7df; }
    * { box-sizing: border-box; }
    html, body { height:100%; margin:0; background:#07121f; color:var(--text); font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 20px 16px 40px; }
    .title { font-size: 24px; font-weight: 800; letter-spacing: .2px; display:flex; align-items:center; gap:10px; }
    .streak { margin-left:auto; padding:6px 10px; border-radius:999px; background:rgba(255,145,0,.12); color:#ffb15a; border:1px solid rgba(255,145,0,.35); font-weight:800; font-size:12px; }
    .card { background: linear-gradient(180deg, var(--card), #0c1d2e 60%); border:1px solid #0e2a41; border-radius: 18px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .meter { position: relative; height: 240px; border-radius: 22px; overflow: hidden; background: radial-gradient(120% 100% at 50% 0%, #123353, #0c1f33); border:1px solid #184664; }
    .meter-overlay { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:space-between; padding:14px; pointer-events:none; }
    .percent { font-size: 36px; font-weight: 900; text-shadow: 0 2px 10px rgba(0,0,0,.4); }
    .sub { opacity:.95; color:#dff3ff; font-size:12px; letter-spacing:.4px; }
    .totals { font-weight:700; margin-top:6px; padding:6px 10px; background:rgba(255,255,255,.08); border-radius: 10px; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .btns { display:flex; gap:8px; flex-wrap: wrap; }
    button { background: var(--blue); border:none; color:white; font-weight:800; padding:12px 14px; border-radius: 12px; cursor:pointer; box-shadow: 0 6px 18px rgba(14,165,233,.35); }
    button.secondary { background: transparent; color: var(--text); border:1px solid #2a5f86; box-shadow:none; }
    button:active { transform: translateY(1px); }
    input[type="number"], input[type="text"] { width:100%; background:#092032; color:var(--text); border:1px solid #1b3c56; border-radius:12px; padding:12px 12px; font-weight:700; }
    label { font-size:12px; color: var(--muted); text-transform: uppercase; letter-spacing:.6px; }
    .section { margin-top:16px; }
    .history { margin-top:8px; display:flex; flex-direction:column; gap:8px; }
    .hist-row { display:flex; align-items:center; gap:8px; }
    .hist-date { color: var(--muted); min-width: 120px; }
    progress { width:100%; height:10px; border:1px solid #1c3f5a; border-radius:999px; overflow:hidden; }
    progress::-webkit-progress-bar { background:#0a2234; }
    progress::-webkit-progress-value { background: var(--blue); }
    .motivation { color:#7cd1ff; font-weight:800; margin-top:4px; text-align:center; }
    .tip { color:#9cc7df; font-size:12px; text-align:center; opacity:.9; margin-top:8px; }
    footer { opacity:.6; font-size:12px; margin-top: 18px; text-align:center; }
    .pill { padding:6px 10px; border:1px solid #2a5f86; border-radius: 999px; font-weight:700; }

    /* Confetti canvas overlays the meter */
    .confetti {
      position:absolute; inset:0; pointer-events:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      💧 Water Tracker
      <span id="streakBadge" class="streak" style="display:none;">🔥 3-Day Streak!</span>
    </div>

    <div class="card section">
      <div class="meter" id="meter">
        <canvas id="waveCanvas"></canvas>
        <canvas id="confettiCanvas" class="confetti"></canvas>
        <div class="meter-overlay">
          <div class="percent" id="percentLabel">0%</div>
          <div class="totals" id="totalsLabel">0 / 100 oz</div>
        </div>
      </div>
      <div class="motivation" id="motivation">Let’s get that first glass in! 💧</div>
      <div class="tip">Install to your Home Screen for a full-screen app. (Share → Add to Home Screen)</div>
    </div>

    <div class="card section">
      <div class="row">
        <div>
          <label>Quick add</label>
          <div class="btns" style="margin-top:8px">
            <button data-add="8">+8 oz</button>
            <button data-add="12">+12 oz</button>
            <button data-add="16">+16 oz</button>
            <button data-add="24">+24 oz</button>
          </div>
        </div>
      </div>

      <div class="row section">
        <div>
          <label>Manual set (today)</label>
          <div class="row" style="margin-top:8px">
            <input id="manualInput" type="number" min="0" inputmode="numeric" placeholder="e.g., 64">
            <button class="secondary" id="setBtn">Set Today</button>
          </div>
        </div>
      </div>

      <div class="row section">
        <div>
          <label>Daily goal</label>
          <div class="row" style="margin-top:8px">
            <input id="goalInput" type="number" min="20" max="300" inputmode="numeric" placeholder="100">
            <button class="secondary" id="goalBtn">Update Goal</button>
          </div>
        </div>
        <div style="max-width:160px; display:flex; align-items:flex-end; justify-content:flex-end;">
          <button class="secondary pill" id="resetTodayBtn" title="Reset today to zero">Reset Today</button>
        </div>
      </div>
    </div>

    <div class="card section">
      <div class="row" style="align-items:center; justify-content:space-between">
        <label>Recent days</label>
        <button class="secondary" id="exportBtn">Export CSV</button>
      </div>
      <div class="history" id="history"></div>
    </div>

    <footer>Offline-first. Your data stays on your device.</footer>
  </div>

  <script>
    // ---------- Storage & State ----------
    const store = {
      key: 'water-tracker-v2', // bumped for new features
      load() { try { return JSON.parse(localStorage.getItem(this.key)) || null; } catch { return null; } },
      save(data) { localStorage.setItem(this.key, JSON.stringify(data)); }
    };

    const todaySOD = () => { const d = new Date(); d.setHours(0,0,0,0); return d.toISOString(); };
    const initialData = () => ({ goal: 100, logs: [ { date: todaySOD(), ounces: 0 } ], lastCelebrated: null });

    let data = store.load() || initialData();
    function ensureToday() {
      const t = todaySOD();
      if (!data.logs.find(l => l.date === t)) { data.logs.unshift({ date: t, ounces: 0 }); store.save(data); }
    }
    ensureToday();

    // ---------- Helpers ----------
    function fmtDate(iso) { const d = new Date(iso); return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' }); }
    function progress() { const today = data.logs[0] || { ounces: 0 }; return Math.min(1, (data.goal ? today.ounces / data.goal : 0)); }
    function motivationText(p) {
      if (p < 0.25) return "Let’s get that first glass in! 💧";
      if (p < 0.5)  return "Nice start—keep it flowing! 🚿";
      if (p < 0.75) return "Halfway hydrated! ⚡️";
      if (p < 1.0)  return "So close—one more sip! 🌊";
      return "Goal crushed! 🏆";
    }
    function isGoalHit(log) { return log.ounces >= data.goal && data.goal > 0; }
    function streakDays() {
      let streak = 0;
      for (const l of data.logs) {
        if (isGoalHit(l)) streak++; else break;
      }
      return streak;
    }

    // ---------- UI Refs ----------
    const percentLabel = document.getElementById('percentLabel');
    const totalsLabel  = document.getElementById('totalsLabel');
    const historyEl    = document.getElementById('history');
    const goalInput    = document.getElementById('goalInput');
    const goalBtn      = document.getElementById('goalBtn');
    const manualInput  = document.getElementById('manualInput');
    const setBtn       = document.getElementById('setBtn');
    const resetTodayBtn = document.getElementById('resetTodayBtn');
    const exportBtn    = document.getElementById('exportBtn');
    const streakBadge  = document.getElementById('streakBadge');

    document.querySelectorAll('[data-add]').forEach(btn => {
      btn.addEventListener('click', () => {
        ensureToday();
        const add = parseInt(btn.getAttribute('data-add'), 10) || 0;
        data.logs[0].ounces = Math.max(0, (data.logs[0].ounces || 0) + add);
        store.save(data);
        manualInput.value = '';
        render();
      });
    });
    goalBtn.addEventListener('click', () => {
      const g = parseInt(goalInput.value, 10);
      if (!isNaN(g) && g > 0) { data.goal = Math.min(300, Math.max(20, g)); store.save(data); render(); }
    });
    setBtn.addEventListener('click', () => {
      ensureToday();
      const v = parseInt(manualInput.value, 10);
      if (!isNaN(v) && v >= 0) { data.logs[0].ounces = v; store.save(data); manualInput.value = ''; render(); }
    });
    resetTodayBtn.addEventListener('click', () => { ensureToday(); data.logs[0].ounces = 0; store.save(data); render(); });
    exportBtn.addEventListener('click', () => {
      const rows = [['Date','Ounces','Goal']];
      data.logs.forEach(l => rows.push([fmtDate(l.date), l.ounces, data.goal]));
      const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'water_history.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    // ---------- History render ----------
    function renderHistory() {
      historyEl.innerHTML = '';
      const recent = data.logs.slice(0, 14);
      recent.forEach(l => {
        const p = Math.min(1, (data.goal ? l.ounces / data.goal : 0));
        const row = document.createElement('div'); row.className = 'hist-row';
        const date = document.createElement('div'); date.className='hist-date'; date.textContent = fmtDate(l.date);
        const amt  = document.createElement('div'); amt.style.minWidth='70px'; amt.style.textAlign='right'; amt.textContent = `${l.ounces} oz`;
        const prog = document.createElement('progress'); prog.max = 1; prog.value = p;
        row.append(date, prog, amt); historyEl.appendChild(row);
      });
    }

    // ---------- Confetti ----------
    const confettiCanvas = document.getElementById('confettiCanvas');
    const cctx = confettiCanvas.getContext('2d');
    let confetti = [];
    let confettiEnd = 0;

    function startConfetti() {
      const now = performance.now();
      confettiEnd = now + 3000; // 3 seconds
      confetti = Array.from({length: 140}, () => ({
        x: Math.random() * confettiCanvas.width,
        y: -10 - Math.random() * 100,
        vx: (Math.random() - 0.5) * 1.5,
        vy: 1 + Math.random() * 2,
        size: 3 + Math.random() * 3,
        hue: Math.floor(180 + Math.random() * 160)
      }));
    }
    function drawConfetti() {
      const now = performance.now();
      cctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      if (now < confettiEnd) {
        confetti.forEach(p => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.01;
          if (p.y > confettiCanvas.height + 10) { p.y = -10; p.vy = 1 + Math.random()*2; }
          cctx.fillStyle = `hsl(${p.hue},90%,60%)`;
          cctx.fillRect(p.x, p.y, p.size, p.size);
        });
      }
    }

    // ---------- Wave + Fish Canvas ----------
    const canvas = document.getElementById('waveCanvas');
    const ctx = canvas.getContext('2d');
    let phase = 0;

    function resizeCanvases() {
      const rect = canvas.parentElement.getBoundingClientRect();
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      [canvas, confettiCanvas].forEach(cv => {
        cv.width = Math.floor(rect.width * dpr);
        cv.height = Math.floor(rect.height * dpr);
        cv.style.width = rect.width + 'px';
        cv.style.height = rect.height + 'px';
      });
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      cctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener('resize', resizeCanvases, { passive: true });
    resizeCanvases();

    // ---- Fish engine ----
    const fishies = []; // {x,y,vx,vy,size,flipTimer}
    function targetFishCount(p) { return Math.min(4, Math.floor(p * 4)); }
    function ensureFishCount(n, waterTop, w, h) {
      // Add fish
      while (fishies.length < n) {
        const size = 0.7 + Math.random()*0.5; // 70% to 120%
        const y = waterTop + 20 + Math.random() * (h - waterTop - 30);
        fishies.push({
          x: Math.random()*w,
          y,
          vx: (Math.random() * 1.2 + 0.4) * (Math.random()<0.5 ? 1 : -1),
          vy: (Math.random() * 0.4 - 0.2),
          size,
          flipTimer: 800 + Math.random()*1800
        });
      }
      // Remove fish
      while (fishies.length > n) fishies.pop();
    }
    function updateFish(dt, waterTop, w, h) {
      fishies.forEach(f => {
        f.x += f.vx * dt * 0.06;
        f.y += f.vy * dt * 0.06;
        f.flipTimer -= dt;
        // Random direction change
        if (f.flipTimer <= 0) {
          f.vx = (Math.random() * 1.2 + 0.4) * (Math.random()<0.5 ? 1 : -1);
          f.vy = (Math.random() * 0.6 - 0.3);
          f.flipTimer = 800 + Math.random()*1800;
        }
        // Bounds: inside water
        if (f.y < waterTop + 14) { f.y = waterTop + 14; f.vy = Math.abs(f.vy); }
        if (f.y > h - 12)       { f.y = h - 12;       f.vy = -Math.abs(f.vy); }
        if (f.x < 8)            { f.x = 8;            f.vx = Math.abs(f.vx); }
        if (f.x > w - 8)        { f.x = w - 8;        f.vx = -Math.abs(f.vx); }
      });
    }
    // Draw a small realistic-ish blue fish (canvas vector)
    function drawFish(f) {
      ctx.save();
      ctx.translate(f.x, f.y);
      const facingLeft = f.vx < 0;
      ctx.scale(facingLeft ? -f.size : f.size, f.size);

      // body
      ctx.beginPath();
      ctx.ellipse(0, 0, 16, 9, 0, 0, Math.PI * 2);
      const grad = ctx.createLinearGradient(-16,0,16,0);
      grad.addColorStop(0, '#0b78c3');
      grad.addColorStop(1, '#7cc7ff');
      ctx.fillStyle = grad;
      ctx.fill();

      // tail
      ctx.beginPath();
      ctx.moveTo(-18, 0);
      ctx.lineTo(-28, -6);
      ctx.lineTo(-28, 6);
      ctx.closePath();
      ctx.fillStyle = '#0a5ea0';
      ctx.fill();

      // dorsal fin
      ctx.beginPath();
      ctx.moveTo(-2, -9);
      ctx.quadraticCurveTo(2, -14, 8, -9);
      ctx.quadraticCurveTo(2, -8, -2, -9);
      ctx.fillStyle = '#0aa0ff';
      ctx.fill();

      // eye
      ctx.beginPath();
      ctx.arc(8, -1, 1.8, 0, Math.PI*2);
      ctx.fillStyle = '#fff';
      ctx.fill();
      ctx.beginPath();
      ctx.arc(8.4, -1, 0.8, 0, Math.PI*2);
      ctx.fillStyle = '#001a33';
      ctx.fill();

      ctx.restore();
    }

    // ---------- Draw loop ----------
    let lastTs = performance.now();
    function drawWaveAndFish(p) {
      const w = canvas.clientWidth, h = canvas.clientHeight;
      const level = h * (1 - p);
      const amp = Math.max(3, Math.min(8, h * 0.03));
      const k = (Math.PI * 2) / w;

      // Clear
      ctx.clearRect(0,0,w,h);

      // Clip rounded rect
      const r = 22;
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(r, 0); ctx.lineTo(w - r, 0); ctx.quadraticCurveTo(w, 0, w, r);
      ctx.lineTo(w, h - r); ctx.quadraticCurveTo(w, h, w - r, h);
      ctx.lineTo(r, h); ctx.quadraticCurveTo(0, h, 0, h - r);
      ctx.lineTo(0, r); ctx.quadraticCurveTo(0, 0, r, 0);
      ctx.closePath(); ctx.clip();

      // Background tint
      const bgGrad = ctx.createLinearGradient(0,0,0,h);
      bgGrad.addColorStop(0, '#0c2a44'); bgGrad.addColorStop(1, '#0a2236');
      ctx.fillStyle = bgGrad; ctx.fillRect(0,0,w,h);

      // Wave path
      const wavePath = new Path2D();
      wavePath.moveTo(0, h);
      wavePath.lineTo(0, level);
      const step = 6;
      for (let x = 0; x <= w; x += step) {
        const y = level + Math.sin(x * k + phase) * amp;
        wavePath.lineTo(x, y);
      }
      wavePath.lineTo(w, h);
      wavePath.closePath();

      // Water gradient
      const grad = ctx.createLinearGradient(0, level-amp*2, 0, h);
      grad.addColorStop(0, '#2cb5ff');
      grad.addColorStop(1, '#0ea5e9');
      ctx.fillStyle = grad;
      ctx.fill(wavePath);

      // Fish update & draw (inside water only)
      const desired = targetFishCount(p);
      ensureFishCount(desired, level, w, h);
      const now = performance.now();
      const dt = now - lastTs; lastTs = now;
      updateFish(dt, level, w, h);

      // Clip to water so fish are "in" the water
      ctx.save();
      ctx.clip(wavePath);
      fishies.forEach(drawFish);
      ctx.restore();

      // Gloss border
      ctx.strokeStyle = 'rgba(255,255,255,.25)';
      ctx.lineWidth = 1;
      ctx.strokeRect(0.5,0.5,w-1,h-1);

      ctx.restore();
    }

    function animate() {
      ensureToday();
      const p = progress();

      // confetti draw
      drawConfetti();

      // wave & fish
      phase += 0.04;
      drawWaveAndFish(p);

      requestAnimationFrame(animate);
    }

    // ---------- Main render ----------
    function render() {
      ensureToday();
      const p = progress();
      percentLabel.textContent = `${Math.round(p*100)}%`;
      totalsLabel.textContent  = `${data.logs[0].ounces} / ${data.goal} oz`;
      document.getElementById('motivation').textContent = motivationText(p);
      renderHistory();

      // Streak badge
      const s = streakDays();
      if (s >= 3) { streakBadge.style.display = ''; streakBadge.textContent = `🔥 ${s}-Day Streak!`; }
      else { streakBadge.style.display = 'none'; }

      // Celebrate once per day on first reach of goal
      const todayIso = todaySOD();
      if (p >= 1 && data.lastCelebrated !== todayIso) {
        startConfetti();
        data.lastCelebrated = todayIso;
        store.save(data);
      }
    }

    // Initial boot
    goalInput.value = data.goal;
    render();
    requestAnimationFrame(animate);

    // Service worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
    }
  </script>
</body>
</html>

